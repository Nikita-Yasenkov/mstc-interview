<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interview Responses (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 12px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    input, textarea, button, select { padding:8px; margin:6px 0; }
    .row { display:flex; gap:12px; align-items:center; }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px 0; }
    .muted { color:#666; font-size: 0.9em; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid #e5e5e5; padding:8px; text-align:left; vertical-align: top; }
    pre { white-space: pre-wrap; word-break: break-word; background:#f7f7f7; padding:8px; border-radius:6px; }
    .hidden { display:none; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:999px; margin:2px; font-size:12px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h2>Responses (Admin)</h2>
    <div>
      <span id="whoami" class="muted">Not signed in</span>
      <button id="signoutBtn" class="hidden">Sign out</button>
    </div>
  </header>

  <div id="authForm" class="card">
    <h3>Admin sign in</h3>
    <div class="muted">Only whitelisted emails can sign up.</div>
    <label>Email <input id="email" type="email" placeholder="you@example.com"></label>
    <label>Password <input id="password" type="password" placeholder="At least 6 characters"></label>
    <div class="row">
      <button id="signupBtn">Sign up</button>
      <button id="signinBtn">Sign in</button>
    </div>
    <div id="authMsg" class="muted"></div>
    <div class="muted" id="whitelistWrap" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <h3>Admin Whitelist</h3>
    <div id="adminList"></div>
  </div>

  <div id="adminOnly" class="hidden">
    <div class="card">
      <div class="row">
        <label style="min-width:220px;">
          Select interview:
          <select id="interviewSelect"></select>
        </label>
        <button id="refreshBtn">Refresh</button>
      </div>
      <div id="tableWrap"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://zhtkgfouvtqjhzvsxcpp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpodGtnZm91dnRxamh6dnN4Y3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDM0NDAsImV4cCI6MjA3Mjg3OTQ0MH0.U1HPWpOG2HoH42F7EAACBfyEwt6INVKLBkz-jmwJEgM";
    const ADMIN_EMAILS = [
      "nikita@yasenkov.com"
    ];

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const byId = (id) => document.getElementById(id);
    const whoami = byId('whoami');
    const authForm = byId('authForm');
    const authMsg = byId('authMsg');
    const whitelistWrap = byId('whitelistWrap');
    const signinBtn = byId('signinBtn');
    const signupBtn = byId('signupBtn');
    const signoutBtn = byId('signoutBtn');
    const adminOnly = byId('adminOnly');
    const adminList = byId('adminList');
    adminList.innerHTML = ADMIN_EMAILS.map(e => `<span class="pill">${e}</span>`).join(" ");
    whitelistWrap.textContent = `Allowed: ${ADMIN_EMAILS.join(", ")}`;

    async function ensureProfileAsAdmin(user) {
      await supabase.from('profiles').upsert({
        id: user.id,
        email: user.email,
        role: 'admin'
      });
    }

    function setAuthedUI(email) {
      whoami.textContent = `Signed in as ${email}`;
      signoutBtn.classList.remove('hidden');
      authForm.classList.add('hidden');
      adminOnly.classList.remove('hidden');
    }
    function setSignedOutUI() {
      whoami.textContent = 'Not signed in';
      signoutBtn.classList.add('hidden');
      authForm.classList.remove('hidden');
      adminOnly.classList.add('hidden');
    }

    async function checkIsAdmin() {
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user || null;
      if (!user) { setSignedOutUI(); return; }
      const email = user.email || "";
      const { data: me } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (me?.role === 'admin' && ADMIN_EMAILS.includes(email)) {
        setAuthedUI(email);
        await loadInterviews();
      } else {
        await supabase.auth.signOut();
        setSignedOutUI();
        alert('Access denied: not an admin.');
      }
    }

    signupBtn.onclick = async () => {
      const email = byId('email').value.trim();
      const password = byId('password').value;
      if (!email || !password) { authMsg.textContent = "Email and password required."; return; }
      if (!ADMIN_EMAILS.includes(email)) { authMsg.textContent = "This email is not allowed to sign up."; return; }
      authMsg.textContent = "Signing up...";
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) { authMsg.textContent = error.message; return; }
      if (data.user) {
        await ensureProfileAsAdmin(data.user);
        authMsg.textContent = "Sign-up successful.";
        await checkIsAdmin();
      } else {
        authMsg.textContent = "Sign-up created. If confirmations are ON, check email and then sign in.";
      }
    };

    signinBtn.onclick = async () => {
      console.log('🚀 BUTTON CLICKED! Sign in button was pressed');
      
      const email = byId('email').value.trim();
      const password = byId('password').value;
      
      console.log('🔍 DEBUG: Starting sign-in process');
      console.log('📧 Email entered:', email);
      console.log('🔑 Password length:', password.length);
      console.log('✅ Whitelisted emails:', ADMIN_EMAILS);
      console.log('🎯 Email in whitelist?', ADMIN_EMAILS.includes(email));
      
      if (!email || !password) { 
        authMsg.textContent = "❌ Email and password required."; 
        console.log('❌ Missing email or password');
        return; 
      }
      
      authMsg.textContent = "🔄 Signing in...";
      console.log('🚀 Attempting Supabase authentication...');
      
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      
      console.log('📊 Supabase response data:', data);
      console.log('❗ Supabase error:', error);
      
      if (error) { 
        authMsg.textContent = `❌ ${error.message}`; 
        console.log('💥 Authentication failed:', error.message);
        console.log('🔍 Error details:', error);
        return; 
      }
      
      console.log('✅ Supabase authentication successful');
      console.log('👤 User object:', data.user);
      
      if (!ADMIN_EMAILS.includes(email)) {
        console.log('🚫 Email not in admin whitelist, signing out...');
        await supabase.auth.signOut();
        authMsg.textContent = "❌ Access denied. This email is not admin whitelisted.";
        return;
      }
      
      console.log('✅ Email is whitelisted, proceeding...');
      
      if (data.user) {
        console.log('👥 Creating/updating admin profile...');
        await ensureProfileAsAdmin(data.user);
      }
      
      authMsg.textContent = "✅ Signed in successfully!";
      console.log('🎉 Sign-in process completed, checking admin status...');
      await checkIsAdmin();
    };

    signoutBtn.onclick = async () => { await supabase.auth.signOut(); setSignedOutUI(); };
    
    console.log('🔧 Setting up event handlers...');
    console.log('📝 Sign-in handler attached:', typeof signinBtn.onclick === 'function');
    console.log('📝 Sign-up handler attached:', typeof signupBtn.onclick === 'function');
    console.log('📝 Sign-out handler attached:', typeof signoutBtn.onclick === 'function');
    
    supabase.auth.onAuthStateChange(() => { checkIsAdmin(); });
    console.log('🔄 Starting initial admin check...');
    checkIsAdmin();

    // ===== Responses =====
    async function loadInterviews() {
      const sel = byId('interviewSelect');
      const { data, error } = await supabase
        .from('interviews')
        .select('id,title,created_at')
        .order('created_at', { ascending: false });
      if (error) { alert(error.message); return; }
      sel.innerHTML = (data || []).map(i => `<option value="${i.id}">${i.title}</option>`).join('');
      await loadResponses();
    }

    async function loadResponses() {
      const id = byId('interviewSelect').value;
      if (!id) return;

      const { data: qs } = await supabase
        .from('questions')
        .select('id,prompt,sort_order')
        .eq('interview_id', id)
        .order('sort_order', { ascending: true });

      const qMap = {}; (qs || []).forEach(q => qMap[q.id] = q.prompt);

      const { data: rows, error } = await supabase
        .from('responses')
        .select('id, respondent_name, respondent_email, answers, submitted_at')
        .eq('interview_id', id)
        .order('submitted_at', { ascending: false });
      if (error) { alert(error.message); return; }

      const table = `
        <table>
          <thead>
            <tr>
              <th>Submitted</th>
              <th>Respondent</th>
              <th>Answers</th>
            </tr>
          </thead>
          <tbody>
            ${(rows || []).map(r => {
              const answers = r.answers || {};
              const pretty = Object.entries(answers).map(([qid, val]) => {
                const prompt = qMap[qid] || qid;
                return `• ${prompt}\n${val || ''}`;
              }).join('\n\n');
              const who = [r.respondent_name, r.respondent_email].filter(Boolean).join(' — ');
              return `
                <tr>
                  <td>${new Date(r.submitted_at).toLocaleString()}</td>
                  <td>${who || 'Anonymous'}</td>
                  <td><pre>${pretty}</pre></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      byId('tableWrap').innerHTML = table || '<p class="muted">No responses yet.</p>';
    }

    byId('refreshBtn').onclick = loadResponses;
    byId('interviewSelect').onchange = loadResponses;
  </script>
</body>
</html>
