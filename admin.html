<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interview Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 800px; margin: 24px auto; padding: 0 12px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    input, textarea, button, select { padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px 0; }
    .muted { color:#666; font-size: 0.9em; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:999px; margin:2px; font-size:12px; }
    .hidden { display:none; }
    code { background:#f6f6f6; padding:2px 4px; border-radius:4px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h2>Interview Admin</h2>
    <div id="authBox">
      <span id="whoami" class="muted">Not signed in</span>
      <button id="signoutBtn" class="hidden">Sign out</button>
    </div>
  </header>

  <!-- Email + Password Auth (no magic links) -->
  <div id="authForm" class="card">
    <h3>Admin sign in</h3>
    <div class="muted">Only whitelisted emails can sign up.</div>
    <label>Email <input id="email" type="email" placeholder="you@example.com"></label>
    <label>Password <input id="password" type="password" placeholder="At least 6 characters"></label>
    <div class="row">
      <button id="signupBtn">Sign up</button>
      <button id="signinBtn">Sign in</button>
    </div>
    <div id="authMsg" class="muted"></div>
    <div class="muted" id="whitelistWrap" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <h3>Admin Whitelist</h3>
    <p class="muted">Only these emails can register as admins (hardcoded here):</p>
    <div id="adminList"></div>
  </div>

  <div id="adminOnly" class="hidden">
    <div class="card">
      <h3>Create Interview</h3>
      <label>Title <input id="title" placeholder="e.g., Backend Engineer Interview"></label>
      <label>Description <textarea id="description" placeholder="Short description"></textarea></label>
      <label><input type="checkbox" id="is_public" checked> Public (anyone can view questions & submit)</label>
      <h4>Questions</h4>
      <div id="qs"></div>
      <div class="row">
        <input id="newQ" placeholder="Type a question...">
        <button id="addQBtn">Add Question</button>
      </div>
      <button id="saveBtn">Save Interview</button>
      <div id="saveMsg" class="muted"></div>
    </div>

    <div class="card">
      <h3>Your Interviews</h3>
      <div id="interviewList"></div>
    </div>
  </div>

  <script>
    // 1) CONFIG
    const SUPABASE_URL = "https://zhtkgfouvtqjhzvsxcpp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpodGtnZm91dnRxamh6dnN4Y3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDM0NDAsImV4cCI6MjA3Mjg3OTQ0MH0.U1HPWpOG2HoH42F7EAACBfyEwt6INVKLBkz-jmwJEgM";
    const ADMIN_EMAILS = [
      "nikita@yasenkov.com"
    ];

    // 2) INIT
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 3) Helpers
    const byId = (id) => document.getElementById(id);
    const whoami = byId('whoami');
    const authForm = byId('authForm');
    const authMsg = byId('authMsg');
    const whitelistWrap = byId('whitelistWrap');
    const signinBtn = byId('signinBtn');
    const signupBtn = byId('signupBtn');
    const signoutBtn = byId('signoutBtn');
    const adminOnly = byId('adminOnly');
    const adminList = byId('adminList');
    adminList.innerHTML = ADMIN_EMAILS.map(e => `<span class="pill">${e}</span>`).join(" ");
    whitelistWrap.textContent = `Allowed: ${ADMIN_EMAILS.join(", ")}`;

    async function ensureProfileAsAdmin(user) {
      // Always set role to admin if email in whitelist; otherwise deny in UI.
      await supabase.from('profiles').upsert({
        id: user.id,
        email: user.email,
        role: 'admin'
      });
    }

    function setAuthedUI(userEmail) {
      whoami.textContent = `Signed in as ${userEmail}`;
      signoutBtn.classList.remove('hidden');
      authForm.classList.add('hidden');
      adminOnly.classList.remove('hidden');
    }
    function setSignedOutUI() {
      whoami.textContent = 'Not signed in';
      signoutBtn.classList.add('hidden');
      authForm.classList.remove('hidden');
      adminOnly.classList.add('hidden');
    }

    async function checkIsAdmin() {
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user || null;
      if (!user) { setSignedOutUI(); return; }
      const email = user.email || "";
      whoami.textContent = `Signed in as ${email}`;
      // Only admins may proceed
      const { data: me } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (me?.role === 'admin') {
        setAuthedUI(email);
        await loadInterviews();
      } else {
        await supabase.auth.signOut();
        setSignedOutUI();
        alert('Access denied: not an admin.');
      }
    }

    // Auth: Sign Up (only if email is whitelisted)
    signupBtn.onclick = async () => {
      const email = byId('email').value.trim();
      const password = byId('password').value;
      if (!email || !password) { authMsg.textContent = "Email and password required."; return; }
      if (!ADMIN_EMAILS.includes(email)) { authMsg.textContent = "This email is not allowed to sign up."; return; }
      authMsg.textContent = "Signing up...";
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) { authMsg.textContent = error.message; return; }

      // If email confirmations are OFF, a session exists now:
      const user = data.user;
      if (user) {
        await ensureProfileAsAdmin(user);
        authMsg.textContent = "Sign-up successful.";
        await checkIsAdmin();
      } else {
        authMsg.textContent = "Sign-up created. If confirmations are ON, check email and then sign in.";
      }
    };

    // Auth: Sign In (password)
    signinBtn.onclick = async () => {
      const email = byId('email').value.trim();
      const password = byId('password').value;
      if (!email || !password) { authMsg.textContent = "Email and password required."; return; }
      authMsg.textContent = "Signing in...";
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { authMsg.textContent = error.message; return; }
      // Optional: if the signed-in email is NOT in whitelist, block.
      if (!ADMIN_EMAILS.includes(email)) {
        await supabase.auth.signOut();
        authMsg.textContent = "Access denied. This email is not admin whitelisted.";
        return;
      }
      // Make sure profile exists & is admin
      if (data.user) await ensureProfileAsAdmin(data.user);
      authMsg.textContent = "Signed in.";
      await checkIsAdmin();
    };

    signoutBtn.onclick = async () => { await supabase.auth.signOut(); setSignedOutUI(); };

    // Session watcher
    supabase.auth.onAuthStateChange(() => { checkIsAdmin(); });
    checkIsAdmin();

    // ====== Interview builder (same as before) ======
    const qsDiv = byId('qs');
    const newQ = byId('newQ');
    const addQBtn = byId('addQBtn');
    const saveBtn = byId('saveBtn');
    const saveMsg = byId('saveMsg');
    let questions = []; // {prompt}

    function renderQs() {
      qsDiv.innerHTML = questions.map((q, i) => `
        <div class="row">
          <input value="${q.prompt}" data-idx="${i}" class="q-input"/>
          <button data-rm="${i}">Remove</button>
        </div>
      `).join("");
      qsDiv.querySelectorAll('.q-input').forEach(inp => {
        inp.oninput = e => { questions[+e.target.dataset.idx].prompt = e.target.value; };
      });
      qsDiv.querySelectorAll('button[data-rm]').forEach(btn => {
        btn.onclick = () => { questions.splice(+btn.dataset.rm,1); renderQs(); };
      });
    }
    addQBtn.onclick = () => {
      const t = newQ.value.trim(); if (!t) return;
      questions.push({ prompt: t }); newQ.value = ""; renderQs();
    };

    async function saveInterview() {
      const title = byId('title').value.trim();
      if (!title) { alert("Title is required"); return; }
      const description = byId('description').value.trim();
      const is_public = byId('is_public').checked;

      const { data: interview, error: iErr } = await supabase
        .from('interviews')
        .insert({ title, description, is_public })
        .select()
        .single();
      if (iErr) { alert(iErr.message); return; }

      const rows = questions.map((q, idx) => ({
        interview_id: interview.id,
        prompt: q.prompt,
        sort_order: idx + 1
      }));
      if (rows.length) {
        const { error: qErr } = await supabase.from('questions').insert(rows);
        if (qErr) { alert(qErr.message); return; }
      }

      saveMsg.textContent = "Saved!";
      questions = []; renderQs();
      byId('title').value = ''; byId('description').value = ''; byId('is_public').checked = true;
      await loadInterviews();
    }
    saveBtn.onclick = saveInterview;

    async function loadInterviews() {
      const { data, error } = await supabase
        .from('interviews')
        .select('id,title,is_public,created_at')
        .order('created_at', { ascending: false });
      if (error) { alert(error.message); return; }
      const base = location.origin + location.pathname.replace('admin.html', '');
      const interviewLink = (id) => `${base}interview.html?interview_id=${id}`;
      byId('interviewList').innerHTML = (data || []).map(i => `
        <div class="card">
          <div><strong>${i.title}</strong></div>
          <div class="muted">Public: ${i.is_public ? 'Yes' : 'No'} · Created: ${new Date(i.created_at).toLocaleString()}</div>
          <div>Share link: <code>${interviewLink(i.id)}</code></div>
          <button onclick="navigator.clipboard.writeText('${interviewLink(i.id)}')">Copy link</button>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
